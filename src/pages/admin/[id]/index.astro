---
import AdminLayout from "../../../components/AdminLayout.astro";
import { Admin } from "../../../lib/service";
const { id } = Astro.params
if (!id) {
    return Astro.redirect('/admin')
}
const talk = await Admin.getTalk(+id)
const messages = await Admin.getMessages(+id)
---

<AdminLayout>
    <h1 class="text-3xl text-white font-bold p-4 uppercase text-center">
        Editar conferencia
    </h1>
    <h3 class="text-2xl text-white font-bold p-4 uppercase text-center">{talk.name}</h3>
    <p class="text-white">{talk.description}</p>
    <div class="relative">
        <form data-talk-id={id}>
            <textarea
            class="bg-slate-300 border border-white w-full rounded-2xl mt-4 py-2 px-4 " 
            name="" id="" rows="5">
        </textarea>
        <button class="bg-slate-600 text-white px-4 py-2 rounded-xl absolute bottom-4 right-4">
            Submit
        </button>
        </form>
    </div>
    <div class="flex flex-col gap-4">
    {
        messages.map((message) => (
            <div class="text-white flex flex-col py-4 px-2 gap-4 bg-slate-600 rounded">
                <div class="flex justify-between">
                <p class="font-bold">
                    {message.name}
                </p>
                <p>
                    {message.date}
                </p>
                </div>
                <p >
                    {message.message}
                </p>
            </div>
        ))
    }
    </div>
</AdminLayout>
<script>
import type { IMessage } from "../../../db/type"

    const form = document.querySelector('form')
    form?.addEventListener('submit', async (event) => {
        event.preventDefault()
        const textarea = form.querySelector('textarea')
        const message = (textarea?.value)?.trim()
        const talkId = form?.getAttribute('data-talk-id')   
        if (!message || !talkId) {
            return
        }
        const requestBody: IMessage = {
            message,
            talkId: +talkId,
            userId: 1 
        }
        fetch(`/api/message`, {
            method: 'POST',
            body: JSON.stringify(requestBody)
        })
    })
</script>
<!-- {
  "id": 1,
  "date": 1672531200000,
  "name": "Introducción a React",
  "description": "Fundamentos básicos de React para principiantes",
  "state": "accepted",
  "user_id": 1,
  "hour": 1672588800000,
  "duration": 30
} -->